<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dash</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1 id="header-title">
        <a href="#/" class="header-home-link">
          <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          Dash
        </a>
        <span id="breadcrumb-separator" class="breadcrumb-separator hidden"> ‚Ä∫ </span>
        <span id="breadcrumb-project" class="breadcrumb-project hidden"></span>
      </h1>
    </div>
    <div class="header-right">
      <div class="ollama-status" id="ollama-status" title="Ollama AI Status">
        <span class="ollama-dot"></span>
        <span class="ollama-label">AI</span>
      </div>
      <div class="stats" id="stats">Loading...</div>
      <button class="settings-btn" onclick="showSettingsModal()" title="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chat-modal" class="chat-modal hidden">
    <div class="chat-container">
      <div class="chat-header">
        <h3>Ask about <span id="chat-project-name">Project</span></h3>
        <button class="chat-close" onclick="closeChat()">&times;</button>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="chat-welcome">
          <p>Ask questions about the codebase using local AI.</p>
          <p class="chat-hint">Examples: "How does authentication work?" or "What files handle user login?"</p>
        </div>
      </div>
      <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="Ask a question..." onkeydown="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()" id="chat-send">Send</button>
      </div>
    </div>
  </div>

  <!-- Alerts Banner -->
  <div id="alerts-banner" class="alerts-banner hidden">
    <div class="alerts-container" id="alerts-container">
      <!-- Alerts will be rendered here -->
    </div>
  </div>

  <!-- Portal View -->
  <div id="portal-view" class="portal-container">
    <div class="portal-header">
      <h2>Your Projects</h2>
      <div class="portal-tabs">
        <button class="portal-tab active" onclick="showPortalTab('projects', this)">Projects</button>
        <button class="portal-tab" onclick="showPortalTab('knowledge-base', this)">Knowledge Base</button>
        <button class="portal-tab" onclick="showPortalTab('reports', this)">Reports</button>
      </div>
    </div>

    <!-- Ollama Chat Quick Access -->
    <div class="ollama-quick-access" id="ollama-quick-access">
      <button class="ollama-chat-btn" onclick="showOllamaChat()">
        <svg class="ollama-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>Dash AI</span>
        <span class="ollama-chat-subtitle">Ask anything - portfolio insights, coding help, general questions</span>
      </button>
    </div>

    <div id="portal-grid" class="portal-grid">
      <div class="loading">Loading projects...</div>
    </div>

    <!-- Knowledge Base View -->
    <div id="knowledge-base-view" class="knowledge-base-view hidden">
      <div class="kb-header">
        <h3>Documentation Knowledge Base</h3>
        <p>Save frequently referenced documentation for quick access via chat.</p>
      </div>
      <div class="kb-add-form">
        <input type="url" id="kb-url-input" placeholder="https://docs.example.com/..." class="search-box" style="flex:1;">
        <button onclick="addKnowledgeBaseSource()" class="zoom-btn">Add URL</button>
      </div>
      <div id="kb-sources-list" class="kb-sources-list">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <!-- Reports View -->
    <div id="reports-view" class="reports-view hidden">
      <div class="reports-header">
        <h3>Weekly Reports</h3>
        <button onclick="generateReport()" class="zoom-btn">Generate This Week's Report</button>
      </div>
      <div id="reports-list" class="reports-list">
        <div class="loading">Loading reports...</div>
      </div>

      <!-- Ollama Routing Stats Section -->
      <div class="efficiency-section ollama-section">
        <div class="efficiency-header">
          <h3>Ollama Routing Stats</h3>
          <button onclick="refreshGatewayMetrics()" class="zoom-btn">Refresh</button>
        </div>

        <div class="efficiency-cards">
          <div class="efficiency-card ollama-card">
            <div class="efficiency-card-label">Ollama Queries</div>
            <div class="efficiency-card-value" id="gw-ollama-queries">-</div>
            <div class="efficiency-card-sub" id="gw-ollama-percent">- of total</div>
          </div>
          <div class="efficiency-card api-card">
            <div class="efficiency-card-label">Claude API</div>
            <div class="efficiency-card-value" id="gw-api-queries">-</div>
            <div class="efficiency-card-sub" id="gw-api-percent">- of total</div>
          </div>
          <div class="efficiency-card savings-card">
            <div class="efficiency-card-label">Est. Savings</div>
            <div class="efficiency-card-value" id="gw-savings">$0.00</div>
            <div class="efficiency-card-sub">from local routing</div>
          </div>
          <div class="efficiency-card">
            <div class="efficiency-card-label">Total Queries</div>
            <div class="efficiency-card-value" id="gw-total-queries">-</div>
            <div class="efficiency-card-sub">all time</div>
          </div>
        </div>

        <div class="efficiency-progress-section">
          <h4>Routing Distribution</h4>
          <div class="efficiency-progress-item">
            <div class="efficiency-progress-header">
              <span class="efficiency-progress-label">Local (Ollama + Memory + Cache)</span>
              <span class="efficiency-progress-value" id="gw-local-percent">-</span>
            </div>
            <div class="efficiency-progress-bar">
              <div class="efficiency-progress-fill ollama-fill" id="gw-local-bar" style="width: 0%"></div>
            </div>
            <div class="efficiency-progress-hint">Free queries handled locally</div>
          </div>
        </div>
      </div>

      <!-- Efficiency Metrics Section -->
      <div class="efficiency-section">
        <div class="efficiency-header">
          <h3>Learning Efficiency</h3>
          <button onclick="refreshEfficiency()" class="zoom-btn">Refresh</button>
        </div>

        <!-- Current Stats Cards -->
        <div class="efficiency-cards">
          <div class="efficiency-card">
            <div class="efficiency-card-label">Sessions</div>
            <div class="efficiency-card-value" id="eff-sessions">-</div>
            <div class="efficiency-card-sub">total tracked</div>
          </div>
          <div class="efficiency-card">
            <div class="efficiency-card-label">Corrections</div>
            <div class="efficiency-card-value" id="eff-corrections">-</div>
            <div class="efficiency-card-sub" id="eff-correction-rate">- per session</div>
          </div>
          <div class="efficiency-card">
            <div class="efficiency-card-label">Token Savings</div>
            <div class="efficiency-card-value" id="eff-tokens">-</div>
            <div class="efficiency-card-sub">estimated saved</div>
          </div>
          <div class="efficiency-card">
            <div class="efficiency-card-label">Preferences</div>
            <div class="efficiency-card-value" id="eff-preferences">-</div>
            <div class="efficiency-card-sub" id="eff-pref-confidence">learned</div>
          </div>
        </div>

        <!-- Progress Bars -->
        <div class="efficiency-progress-section">
          <h4>Learning Progress</h4>

          <div class="efficiency-progress-item">
            <div class="efficiency-progress-header">
              <span class="efficiency-progress-label">Correction Rate Improvement</span>
              <span class="efficiency-progress-value" id="eff-correction-progress-val">-</span>
            </div>
            <div class="efficiency-progress-bar">
              <div class="efficiency-progress-fill correction-fill" id="eff-correction-bar" style="width: 0%"></div>
            </div>
            <div class="efficiency-progress-hint" id="eff-correction-hint">Baseline being established...</div>
          </div>

          <div class="efficiency-progress-item">
            <div class="efficiency-progress-header">
              <span class="efficiency-progress-label">Memory Utilization</span>
              <span class="efficiency-progress-value" id="eff-memory-progress-val">-</span>
            </div>
            <div class="efficiency-progress-bar">
              <div class="efficiency-progress-fill memory-fill" id="eff-memory-bar" style="width: 0%"></div>
            </div>
            <div class="efficiency-progress-hint">Token savings from memory vs raw file reads</div>
          </div>

          <div class="efficiency-progress-item">
            <div class="efficiency-progress-header">
              <span class="efficiency-progress-label">Preference Confidence</span>
              <span class="efficiency-progress-value" id="eff-pref-progress-val">-</span>
            </div>
            <div class="efficiency-progress-bar">
              <div class="efficiency-progress-fill preference-fill" id="eff-pref-bar" style="width: 0%"></div>
            </div>
            <div class="efficiency-progress-hint">High-confidence inferred preferences</div>
          </div>
        </div>

        <!-- Projections -->
        <div class="efficiency-projections">
          <h4>12-Week Projection</h4>
          <div id="eff-projection-content" class="efficiency-projection-grid">
            <div class="loading">Loading projections...</div>
          </div>
        </div>

        <!-- Confidence by Domain -->
        <div class="efficiency-domains">
          <h4>Confidence by Domain</h4>
          <div id="eff-domains-content" class="efficiency-domains-grid">
            <div class="efficiency-domain-empty">No domain data yet. Use Claude more to build calibration.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Heatmap Section -->
    <div class="efficiency-section activity-section">
      <div class="efficiency-header">
        <h3>Activity by Project</h3>
        <button onclick="refreshActivityHeatmap()" class="zoom-btn">Refresh</button>
      </div>
      <div class="activity-heatmap" id="activity-heatmap">
        <div class="loading">Loading activity data...</div>
      </div>
      <div class="activity-total" id="activity-total"></div>
    </div>

    <!-- Recent Session Summaries Section -->
    <div class="efficiency-section sessions-section">
      <div class="efficiency-header">
        <h3>Recent Session Summaries</h3>
        <button onclick="refreshSessionSummaries()" class="zoom-btn">Refresh</button>
      </div>
      <div class="session-summaries" id="session-summaries">
        <div class="loading">Loading session summaries...</div>
      </div>
    </div>

    <!-- Transcript Stats Section -->
    <div class="efficiency-section transcripts-section">
      <div class="efficiency-header">
        <h3>Transcript Stats</h3>
        <button onclick="refreshTranscriptStats()" class="zoom-btn">Refresh</button>
      </div>
      <div class="efficiency-cards">
        <div class="efficiency-card">
          <div class="efficiency-card-label">Total Transcripts</div>
          <div class="efficiency-card-value" id="ts-total">-</div>
          <div class="efficiency-card-sub">conversations logged</div>
        </div>
        <div class="efficiency-card">
          <div class="efficiency-card-label">Total Size</div>
          <div class="efficiency-card-value" id="ts-size">-</div>
          <div class="efficiency-card-sub">MB stored</div>
        </div>
        <div class="efficiency-card">
          <div class="efficiency-card-label">Est. Tokens</div>
          <div class="efficiency-card-value" id="ts-tokens">-</div>
          <div class="efficiency-card-sub">processed</div>
        </div>
        <div class="efficiency-card">
          <div class="efficiency-card-label">Largest Session</div>
          <div class="efficiency-card-value" id="ts-largest">-</div>
          <div class="efficiency-card-sub" id="ts-largest-id">-</div>
        </div>
      </div>
    </div>

    <!-- Project Activity Timeline Section -->
    <div class="efficiency-section timeline-section">
      <div class="efficiency-header">
        <h3>Activity Timeline</h3>
        <button onclick="refreshActivityTimeline()" class="zoom-btn">Refresh</button>
      </div>
      <div class="activity-timeline" id="activity-timeline">
        <div class="loading">Loading timeline...</div>
      </div>
    </div>

  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="settings-modal hidden" onclick="if(event.target === this) hideSettingsModal()">
    <div class="settings-modal-content">
      <div class="settings-modal-header">
        <h3>Settings</h3>
        <button class="settings-close" onclick="hideSettingsModal()">&times;</button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-section">
          <h4>API Status</h4>
          <p class="settings-desc">Direct API integration - no external dependencies.</p>

          <div id="api-status" class="api-status">
            <div class="api-item">
              <span class="status-dot" id="anthropic-status"></span>
              <span>Claude API (Anthropic)</span>
            </div>
            <div class="api-item">
              <span class="status-dot" id="tavily-status"></span>
              <span>Web Search (Tavily)</span>
            </div>
          </div>

          <p class="settings-hint">API keys are configured in the launchd plist.<br>Features: AI reports, web search, knowledge base extraction.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Ollama Chat View (Standalone) -->
  <div id="ollama-chat-view" class="ollama-chat-view hidden">
    <div class="ollama-chat-header">
      <button class="back-btn" onclick="hideOllamaChat()">
        <svg viewBox="0 0 16 16" fill="currentColor" width="16" height="16">
          <path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 1.06L4.81 7h8.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06z"/>
        </svg>
        Back to Projects
      </button>
      <h2>Dash AI</h2>
      <div class="ollama-chat-actions">
        <select id="ollama-context-mode" class="search-box" style="width: auto;" onchange="handleContextModeChange()">
          <option value="portfolio" selected>Portfolio Context</option>
          <option value="coding">Coding Help</option>
          <option value="fix">Fix Issue (with Claude)</option>
          <option value="general">General Chat</option>
        </select>
        <select id="ollama-project-select" class="search-box hidden" style="width: auto;">
          <option value="">Select a project...</option>
        </select>
        <button class="zoom-btn" onclick="clearOllamaChat()">Clear Chat</button>
      </div>
    </div>

    <div class="ollama-chat-main">
      <!-- Sidebar with suggestions -->
      <div class="ollama-chat-sidebar">
        <div class="sidebar-section">
          <h4>Quick Actions</h4>
          <button class="suggestion-btn" onclick="askOllama('Give me an overview of my project portfolio')">
            Portfolio Overview
          </button>
          <button class="suggestion-btn" onclick="askOllama('Which of my projects has the best code health and why?')">
            Best Code Health
          </button>
          <button class="suggestion-btn" onclick="askOllama('What common patterns exist across my projects?')">
            Common Patterns
          </button>
          <button class="suggestion-btn" onclick="askOllama('What technical debt should I prioritize?')">
            Technical Debt
          </button>
        </div>
        <div class="sidebar-section">
          <h4>Coding Help</h4>
          <button class="suggestion-btn" onclick="askOllama('Explain how React hooks work')">
            React Hooks
          </button>
          <button class="suggestion-btn" onclick="askOllama('Best practices for TypeScript')">
            TypeScript Tips
          </button>
          <button class="suggestion-btn" onclick="askOllama('How to structure a Firebase project')">
            Firebase Structure
          </button>
        </div>
        <div class="sidebar-section">
          <h4>Recent Topics</h4>
          <div id="ollama-recent-topics" class="recent-topics">
            <span class="no-topics">No recent topics</span>
          </div>
        </div>
        <div class="sidebar-section" id="handoff-section" style="display: none;">
          <h4>Claude Code Handoff</h4>
          <p class="sidebar-hint">Describe an issue above, then hand it off to Claude Code to fix.</p>
          <button class="suggestion-btn handoff-btn" onclick="handoffToClaude()" id="handoff-btn" disabled>
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16" style="margin-right: 8px;">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            Hand off to Claude
          </button>
          <div class="handoff-status" id="handoff-status"></div>
        </div>
      </div>

      <!-- Chat area -->
      <div class="ollama-chat-area">
        <div class="ollama-messages" id="ollama-messages">
          <div class="ollama-welcome">
            <div class="welcome-icon">‚ö°</div>
            <h3>Welcome to Dash AI</h3>
            <p>I have full context about all your projects. Ask me about:</p>
            <ul>
              <li><strong>Project Health</strong> - "What's wrong with GYST?" or "Which project needs work?"</li>
              <li><strong>Decisions & Patterns</strong> - "What tech stack does Jamelna use?"</li>
              <li><strong>Comparisons</strong> - "Compare health across my projects"</li>
              <li><strong>Fix Issues</strong> - Select "Fix Issue" mode to hand off to Claude Code</li>
            </ul>
            <p class="welcome-hint">Portfolio Context is active - I know about all 8 of your projects!</p>
          </div>
        </div>

        <div class="ollama-input-area">
          <div class="ollama-input-wrapper">
            <textarea id="ollama-input" placeholder="Ask me anything..." rows="1" onkeydown="handleOllamaKeydown(event)"></textarea>
            <div class="ollama-input-buttons">
              <button class="ollama-send-btn" onclick="sendOllamaMessage()" id="ollama-send-btn" title="Send message">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
              </button>
              <button class="ollama-claude-btn" onclick="showQuickHandoff()" id="ollama-claude-btn" title="Fix with Claude Code">
                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/>
                </svg>
                <span>Claude</span>
              </button>
            </div>
          </div>
          <div class="ollama-input-hint">
            Press Enter to send ¬∑ Click Claude to hand off fixes
          </div>
        </div>

        <!-- Quick Handoff Modal -->
        <div id="quick-handoff-modal" class="quick-handoff-modal hidden">
          <div class="quick-handoff-content">
            <h3>Hand off to Claude Code</h3>
            <p>Select a project and describe what needs to be fixed:</p>
            <select id="quick-handoff-project" class="search-box">
              <option value="">Select a project...</option>
            </select>
            <textarea id="quick-handoff-issue" placeholder="Describe the issue or what you want Claude to fix..." rows="3"></textarea>
            <div class="quick-handoff-actions">
              <button class="zoom-btn" onclick="hideQuickHandoff()">Cancel</button>
              <button class="handoff-btn" onclick="executeQuickHandoff()">Send to Claude</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Container (Project View) -->
  <div class="container hidden" id="project-view">
    <!-- Main Content -->
    <div class="main">
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab-group">
          <button class="tab active" data-tab="code">
            <svg class="tab-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M4.72 3.22a.75.75 0 0 1 1.06 0l3.5 3.5a.75.75 0 0 1 0 1.06l-3.5 3.5a.75.75 0 1 1-1.06-1.06L7.44 7.5 4.72 4.78a.75.75 0 0 1 0-1.06zm3.5 9.25a.75.75 0 0 1 .75-.75h6.25a.75.75 0 0 1 0 1.5H8.97a.75.75 0 0 1-.75-.75z"/></svg>
            Code
          </button>
          <button class="tab" data-tab="architecture">
            <svg class="tab-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M1.5 14.25V1.75h1.25v12.5zM6 14.25v-7h1.25v7zm4.5-10v10h1.25v-10zm4.5 5.5v4.5h1.25v-4.5z"/></svg>
            Architecture
          </button>
          <button class="tab" data-tab="schema">
            <svg class="tab-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M1 3.5A1.5 1.5 0 0 1 2.5 2h11A1.5 1.5 0 0 1 15 3.5v.75H1V3.5zM1 5.75h14v4.5H1v-4.5zm0 6V12.5A1.5 1.5 0 0 0 2.5 14h11a1.5 1.5 0 0 0 1.5-1.5v-.75H1z"/></svg>
            Schema
          </button>
        </div>
        <span class="tab-separator"></span>
        <div class="tab-group">
          <button class="tab" data-tab="health">
            <svg class="tab-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm9-3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM6.75 8a.75.75 0 0 0 0 1.5h1.5v1.75a.75.75 0 0 0 1.5 0V9.5a.75.75 0 0 0-.75-.75h-2.25z"/></svg>
            Health
          </button>
          <button class="tab" data-tab="ask">
            <svg class="tab-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215l-3.04-3.04zM11.5 7a4.5 4.5 0 1 0-9 0 4.5 4.5 0 0 0 9 0z"/></svg>
            Ask
          </button>
          <button class="tab" data-tab="features">
            <svg class="tab-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M8.878.392a1.75 1.75 0 0 0-1.756 0l-5.25 3.045A1.75 1.75 0 0 0 1 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 0 0 1.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392z"/></svg>
            Features
          </button>
        </div>
      </div>

      <!-- Content Area -->
      <div class="content">
        <!-- Code Tab (Files + Functions) -->
        <div id="tab-code" class="tab-content">
          <div class="code-toolbar">
            <div class="view-toggle">
              <button class="view-btn active" data-code-view="files" onclick="setCodeView('files')">Files</button>
              <button class="view-btn" data-code-view="functions" onclick="setCodeView('functions')">Functions</button>
            </div>
            <input type="text" class="search-box" id="code-search" placeholder="Search..." style="flex: 1; max-width: 400px;">
            <div class="code-stats" id="code-stats"></div>
          </div>
          <div id="code-list" class="file-list"></div>
        </div>

        <!-- Architecture Tab (Graph + Wireframe) -->
        <div id="tab-architecture" class="tab-content hidden">
          <div class="architecture-toolbar">
            <div class="view-toggle">
              <button class="view-btn active" data-arch-view="graph" onclick="setArchView('graph')">Dependency Graph</button>
              <button class="view-btn" data-arch-view="screens" onclick="setArchView('screens')">Screen Map</button>
            </div>
            <div class="legend" id="arch-legend">
              <div class="legend-item"><div class="legend-dot" style="background: #f78166"></div> Screens</div>
              <div class="legend-item"><div class="legend-dot" style="background: #a371f7"></div> Components</div>
              <div class="legend-item"><div class="legend-dot" style="background: #58a6ff"></div> Services</div>
              <div class="legend-item"><div class="legend-dot" style="background: #3fb950"></div> Hooks</div>
            </div>
          </div>
          <div id="architecture-content">
            <div id="graph" class="graph-container"></div>
          </div>
          <div id="screen-detail" class="card" style="margin-top: 16px; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 id="screen-detail-title">Screen Details</h3>
              <button onclick="document.getElementById('screen-detail').style.display='none'" class="zoom-btn">Close</button>
            </div>
            <div id="screen-detail-content"></div>
          </div>
        </div>

        <!-- Schema Tab -->
        <div id="tab-schema" class="tab-content hidden">
          <div id="schema-grid" class="collection-grid"></div>
        </div>

        <!-- Health Tab -->
        <div id="tab-health" class="tab-content hidden">
          <!-- Task 12: Staleness Banner Container -->
          <div id="staleness-banner-container"></div>

          <div class="health-header">
            <div class="health-score-container">
              <div class="health-score" id="health-score">--</div>
              <div class="health-label">Health Score</div>
            </div>
            <div class="health-actions">
              <button type="button" class="zoom-btn" id="run-scan">Run Scan</button>
              <button class="zoom-btn fix-all-btn" id="fix-all" disabled>Fix All Safe (<span id="fixable-count">0</span>)</button>
              <span class="health-timestamp" id="health-timestamp">Never scanned</span>
              <div class="fix-buttons-group">
                <select id="fix-by-category" class="fix-dropdown" onchange="handleFixDropdown(this, 'category')">
                  <option value="">Fix by category...</option>
                  <option value="security" disabled>Security (0)</option>
                  <option value="performance" disabled>Performance (0)</option>
                  <option value="maintenance" disabled>Maintenance (0)</option>
                </select>
                <select id="fix-by-severity" class="fix-dropdown" onchange="handleFixDropdown(this, 'severity')">
                  <option value="">Fix by severity...</option>
                  <option value="critical" disabled>Critical (0)</option>
                  <option value="high" disabled>High (0)</option>
                  <option value="medium" disabled>Medium (0)</option>
                  <option value="low" disabled>Low (0)</option>
                </select>
              </div>
            </div>
          </div>

          <div class="health-summary" id="health-summary">
            <div class="health-card critical">
              <div class="health-count" id="security-count">0</div>
              <div class="health-type">Security</div>
            </div>
            <div class="health-card warning">
              <div class="health-count" id="performance-count">0</div>
              <div class="health-type">Performance</div>
            </div>
            <div class="health-card info">
              <div class="health-count" id="duplicates-count">0</div>
              <div class="health-type">Duplicates</div>
            </div>
            <div class="health-card low">
              <div class="health-count" id="deadcode-count">0</div>
              <div class="health-type">Dead Code</div>
            </div>
          </div>

          <div class="card health-trends-card">
            <h3>Health Score Trends</h3>
            <canvas id="health-chart"></canvas>
          </div>

          <div id="trend-chart-container" class="trend-chart-container">
            <h4>Health Score Trend (Last 30 Days)</h4>
          </div>

          <div class="health-issues" id="health-issues">
            <div class="loading">Select a project and run a scan</div>
          </div>

          <!-- Dead Code Analysis (merged from Dead Code tab) -->
          <div class="card" style="margin-top: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleDeadCodeSection()">
              <h3 style="display: flex; align-items: center; gap: 8px;">
                <span id="deadcode-toggle-icon">‚ñ∂</span>
                Dead Code Analysis
                <span class="badge" id="deadcode-total-count" style="background: var(--warning); color: var(--bg-primary);">0</span>
              </h3>
              <div class="deadcode-filters" id="deadcode-filters" style="display: none;">
                <select id="deadcode-type-filter" class="search-box" style="width: auto;" onclick="event.stopPropagation()">
                  <option value="all">All Types</option>
                  <option value="orphan_file">Orphan Files</option>
                  <option value="unused_export">Unused Exports</option>
                  <option value="unused_function">Unused Functions</option>
                </select>
                <select id="deadcode-confidence-filter" class="search-box" style="width: auto;" onclick="event.stopPropagation()">
                  <option value="all">All Confidence</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
            </div>

            <div id="deadcode-sections" class="deadcode-sections" style="display: none; margin-top: 16px;">
              <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                <h4 style="margin-bottom: 8px; color: var(--text-primary);">Orphan Files <span class="badge" id="orphan-count">0</span></h4>
                <div id="orphan-list" class="deadcode-list" style="max-height: 200px; overflow-y: auto;"></div>
              </div>

              <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                <h4 style="margin-bottom: 8px; color: var(--text-primary);">Unused Exports <span class="badge" id="exports-count">0</span></h4>
                <div id="exports-list" class="deadcode-list" style="max-height: 200px; overflow-y: auto;"></div>
              </div>

              <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px;">
                <h4 style="margin-bottom: 8px; color: var(--text-primary);">Unused Functions <span class="badge" id="functions-unused-count">0</span></h4>
                <div id="functions-unused-list" class="deadcode-list" style="max-height: 200px; overflow-y: auto;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Unified Ask Tab -->
        <div id="tab-ask" class="tab-content hidden">
          <div class="ask-header">
            <h2>Ask Anything</h2>
            <p style="color: var(--text-muted); margin-top: 8px;">Search your codebase by meaning - ask questions, find files, explore concepts</p>
          </div>

          <div class="card" style="margin-top: 16px;">
            <div class="ask-input-wrapper" style="display: flex; gap: 8px;">
              <input type="text" class="search-box" id="ask-input" placeholder="What do you want to know? (e.g., 'how does authentication work?', 'where is the login screen?')" style="flex: 1;">
              <button class="zoom-btn fix-all-btn" id="ask-submit">Ask</button>
            </div>
            <div class="ask-examples" style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
              <button class="query-example-btn" onclick="setAskQuery('how does authentication work?')">Auth flow</button>
              <button class="query-example-btn" onclick="setAskQuery('where is the login screen?')">Login screen</button>
              <button class="query-example-btn" onclick="setAskQuery('what collections store user data?')">User data</button>
              <button class="query-example-btn" onclick="setAskQuery('how does navigation work?')">Navigation</button>
              <button class="query-example-btn" onclick="setAskQuery('payment processing')">Payments</button>
            </div>
          </div>

          <!-- Answer Section -->
          <div id="ask-answer" class="card" style="margin-top: 16px; display: none;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <div style="font-size: 24px;">üí°</div>
              <div>
                <div id="ask-answer-text" style="color: var(--text-primary); line-height: 1.6;"></div>
              </div>
            </div>
          </div>

          <!-- Results Section -->
          <div id="ask-results" class="card" style="margin-top: 16px; min-height: 200px;">
            <div class="loading" style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
              <div>Ask a question to search your codebase</div>
              <div style="font-size: 12px; margin-top: 8px; color: var(--text-subtle);">Uses semantic understanding to find relevant files and concepts</div>
            </div>
          </div>
        </div>

        <!-- Features Tab -->
        <div id="tab-features" class="tab-content hidden">
          <div class="features-layout">
            <div class="features-section">
              <div class="card">
                <h3>Feature Modules</h3>
                <div id="features-grid" class="features-grid"></div>
              </div>
            </div>

            <div class="preferences-section">
              <div class="card">
                <h3>Coding Preferences</h3>
                <div id="preferences-editor">
                  <div class="pref-section">
                    <h4>Technology Choices</h4>
                    <div id="pref-use"></div>
                  </div>
                  <div class="pref-section">
                    <h4>Conventions</h4>
                    <div id="pref-conventions"></div>
                    <button class="zoom-btn" id="add-convention" style="margin-top: 8px;">+ Add Convention</button>
                  </div>
                  <div class="pref-section">
                    <h4>Patterns</h4>
                    <div id="pref-patterns"></div>
                  </div>
                </div>
                <div class="pref-actions">
                  <button class="zoom-btn fix-all-btn" id="save-preferences">Save Changes</button>
                </div>
              </div>
            </div>
          </div>
        </div>


      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
